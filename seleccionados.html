<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Productos Seleccionados - ATITUDE</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background-color: #f5f5f5;
        }
        h1 { 
            text-align: center; 
            font-size: 1.8rem; 
            color: #186fb7;
            margin: 20px 0;
        }
        .botonera {
            text-align: center;
            margin-bottom: 30px;
        }
        .botonera button {
            margin: 0 8px 10px 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            background: #186fb7;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        .botonera button:hover {
            background: #0d4a8e;
        }
        .botonera button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .catalogo { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            justify-content: center;
            min-height: 300px;
        }
        .item { 
            border: 2px solid #186fb7;
            padding: 15px; 
            width: 250px; 
            text-align: center; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .item img { 
            max-width: 95%; 
            max-height: 150px; 
            cursor: pointer; 
            border-radius: 6px;
            margin-bottom: 12px;
        }
        .item div {
            text-align: left;
            line-height: 1.8;
        }
        .mensaje-vacio {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 1.3rem;
        }
        .mensaje-vacio a {
            color: #186fb7;
            text-decoration: none;
            font-weight: bold;
        }
        #viewImgPopup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,.8);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #imgZoom {
            max-width: 90vw;
            max-height: 90vh;
            border: 8px solid #fff;
            border-radius: 8px;
        }
        #cerrarPopup {
            color: white;
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2.5rem;
            cursor: pointer;
            z-index: 10001;
            font-weight: bold;
            background: none;
            outline: none;
            border: none;
            user-select: none;
        }
        #cerrarPopup:hover {
            color: #ccc;
        }
        @media screen and (max-width: 600px) {
            .item { width: 90vw; }
            .botonera button { width: 90vw; font-size: 1.1rem; }
            h1 { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

<h1>üì¶ Productos Seleccionados - ATITUDE</h1>

<div class="botonera">
    <button id="descargarPDF">üì• Descargar como TXT</button>
    <button id="enviarWhatsapp">üí¨ Enviar por WhatsApp</button>
    <button onclick="location.href='index.html'" style="background:#666;">‚Üê Volver al cat√°logo</button>
</div>

<div class="catalogo" id="catalogo"></div>
<div class="mensaje-vacio" id="mensajeVacio" style="display:none;">
    ‚ùå No hay productos seleccionados<br><br>
    <a href="index.html">‚Üê Volver al cat√°logo para seleccionar productos</a>
</div>

<div id="viewImgPopup" onclick="this.style.display='none'">
    <span id="cerrarPopup">&times;</span>
    <img id="imgZoom" src="">
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
    const CSV_PATH = "atitude01.csv";
    let seleccionados = JSON.parse(localStorage.getItem('productosSeleccionados') || '{}');
    let cantidades = JSON.parse(localStorage.getItem('cantidadesSeleccionadas') || '{}');
    let productos = [];

    console.log('=== DEBUG INICIAL ===');
    console.log('Seleccionados:', seleccionados);
    console.log('Cantidades:', cantidades);

    function cargarProductos() {
        Papa.parse(CSV_PATH, {
            download: true,
            header: true,
            complete: function(res) {
                console.log('CSV Cargado, total de filas:', res.data.length);
                
                // Filtrar solo productos v√°lidos y seleccionados
                productos = res.data.filter(p => {
                    let idProducto = p.ID || p.MODELO;
                    let esValido = idProducto && (p.MARCA || p.ENLACE);
                    let est√°Seleccionado = seleccionados[idProducto] === true;
                    
                    if(est√°Seleccionado) {
                        console.log('Producto encontrado:', idProducto, p.MODELO);
                    }
                    return esValido && est√°Seleccionado;
                });

                console.log('Productos filtrados:', productos.length);
                mostrarProductos();
            },
            error: function(error) {
                console.error('Error al cargar CSV:', error);
                document.getElementById("catalogo").innerHTML = '<div class="mensaje-vacio">‚ùå Error al cargar los productos. Intenta recargar la p√°gina.</div>';
            }
        });
    }

    function mostrarProductos() {
        let catalogo = document.getElementById("catalogo");
        let mensajeVacio = document.getElementById("mensajeVacio");
        let botones = document.querySelectorAll('.botonera button');

        if(productos.length === 0) {
            console.log('No hay productos seleccionados');
            catalogo.innerHTML = "";
            mensajeVacio.style.display = "block";
            botones.forEach(btn => {
                if(btn.id !== 'enviarWhatsapp' && !btn.textContent.includes('Volver')) {
                    btn.disabled = true;
                }
            });
            return;
        }

        mensajeVacio.style.display = "none";
        botones.forEach(btn => btn.disabled = false);
        catalogo.innerHTML = "";

        productos.forEach(p => {
            let idProducto = p.ID || p.MODELO;
            let cantidad = cantidades[idProducto] || "-";
            let div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
                <img src="${p.ENLACE}" alt="Imagen de ${p.MODELO}" onclick="mostrarImagen('${p.ENLACE.replace(/'/g, "\\'")}')">
                <div>
                    <strong style="color:#186fb7; display:block; margin-bottom:8px;">üî∏ ${p.MODELO}</strong>
                    <strong>Marca:</strong> ${p.MARCA}<br>
                    <strong>Cantidad:</strong> ${cantidad}
                </div>
            `;
            catalogo.appendChild(div);
        });
    }

    window.mostrarImagen = function(src){
        document.getElementById('imgZoom').src = src;
        document.getElementById('viewImgPopup').style.display = "flex";
    };

    document.getElementById('cerrarPopup').onclick = function(e){
        e.stopPropagation();
        document.getElementById('viewImgPopup').style.display = "none";
    };

    window.addEventListener('keydown', function(e){
        if(e.key === "Escape"){
            document.getElementById('viewImgPopup').style.display = 'none';
        }
    });

    document.getElementById('descargarPDF').onclick = function(){
        if(productos.length === 0) {
            alert('No hay productos seleccionados para descargar.');
            return;
        }
        let texto = "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        texto += "   SELECCI√ìN DE PRODUCTOS ATITUDE\n";
        texto += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
        
        productos.forEach((p, idx) => {
            let idProducto = p.ID || p.MODELO;
            texto += `${idx + 1}. Modelo: ${p.MODELO}\n`;
            texto += `   Marca: ${p.MARCA}\n`;
            texto += `   Cantidad: ${cantidades[idProducto] || '-'}\n\n`;
        });
        
        texto += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        texto += "Fecha: " + new Date().toLocaleString('es-ES') + "\n";

        let blob = new Blob([texto], {type:'text/plain;charset=utf-8'});
        let link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'seleccionados_ATITUDE_' + new Date().getTime() + '.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    document.getElementById('enviarWhatsapp').onclick = function(){
        if(productos.length === 0) {
            alert('No hay productos seleccionados para enviar.');
            return;
        }
        let msg = "üìã *SELECCI√ìN DE PRODUCTOS ATITUDE*\n\n";
        
        productos.forEach((p, idx) => {
            let idProducto = p.ID || p.MODELO;
            msg += `${idx + 1}. *${p.MODELO}*\n`;
            msg += `   Marca: ${p.MARCA}\n`;
            msg += `   Cantidad: ${cantidades[idProducto] || '-'}\n\n`;
        });
        
        msg += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
        msg += "Solicitado: " + new Date().toLocaleString('es-ES');
        
        let url = encodeURIComponent(msg);
        window.open(`https://wa.me/595987334125?text=${url}`, '_blank');
    };

    // Cargar productos cuando abra la p√°gina
    cargarProductos();
</script>

</body>
</html>
